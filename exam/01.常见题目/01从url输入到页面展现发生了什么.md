---
title: "从url输入到页面展现发生了什么？"
date: "2020-02-12"
permalink: "exam/2020-02-10-exam-url-to-show"
---

⚡<strong>「内容速览」</strong>⚡

- **从url输入到页面展现发生了什么？**
- DNS解析：将域名解析为ip地址
- TCP连接：TCP三次握手
- 发送HTTP请求
- 服务器处理请求返回HTTP报文
- 浏览器解析文件并渲染页面
- 断开连接：TCP四次挥手
- 回流和重绘

### 从url 输入到页面展现发生了什么？

从我们在浏览器输出到页面过程可以总结为下面6个步骤：

- DNS解析：将域名解析为ip地址
- TCP连接：TCP三次握手
- 发送HTTP请求
- 服务器处理请求返回HTTP报文
- 浏览器解析文件并渲染页面
- 断开连接：TCP四次挥手

### DNS解析
在浏览器输入网址后，浏览器并不能直接通过域名找到对应的服务器，而是需要通过 IP 地址来找到对应服务器，因此首先要进行域名解析。

**DNS解析过程：**

DNS域名解析分为递归查询和迭代查询两种方式。

![noderun](~@images/exam/dns.png)

- 浏览器首先会去本地域名服务器查询IP地址，如果本地域名有缓存则返回，反之继续。

- 本地域名服务器向根域名服务器发送一个请求，查询域名的ip地址，如果根域名服务器不知道ip地址，返回顶级域名服务器的地址让本地域名服务器去查询。

- 查询顶级域名服务器，如不知道则返回二级域名服务器的地址。

- 依次类推直至查询到ip地址，然后缓存到本地域名服务器中。

**DNS优化：**

1. DNS缓存：

DNS存在着多级缓存，从离浏览器的距离排序的话，有以下几种: 浏览器缓存，系统缓存，路由器缓存，IPS服务器缓存，根域名服务器缓存，顶级域名服务器缓存，主域名服务器缓存。

2. dns-prefetch：

DNS Prefetch 是一种 DNS 预解析技术。当你浏览网页时，浏览器会在加载网页时对网页中的域名进行解析缓存，这样在你单击当前网页中的连接时就无需进行 DNS 的解析，减少用户等待时间，提高用户体验。

3. DNS负载均衡：

(DNS重定向) DNS负载均衡技术的实现原理是在DNS服务器中为同一个主机名配置多个IP地址，在应答DNS查询时， DNS服务器对每个查询将以DNS文件中主机记录的IP地址按顺序返回不同的解析结果，将客户端的访问 引导到不同的机器上去，使得不同的客户端访问不同的服务器，从而达到负载均衡的目的。

CDN(Content Delivery Network)就是利用DNS的重定向技术，DNS服务器会返回一个跟用户最接近的点的IP地址给用户，CDN节点的服务器负责响应用户的请求，提供所需的内容。


### TCP连接

- TCP三次握手

[TCP和UDP](/notes/2020-01-30-TCP-and-UDP)

### 发送HTTP请求

- 请求报文：请求行、请求头、请求正文

[http和https](/notes/2020-01-30-http-https)

### 服务器处理请求返回HTTP报文

- 响应报文：响应行、响应头、响应正文

[http和https](/notes/2020-01-30-http-https)

### 浏览器解析渲染页面

浏览器由7个部分构成：

- 用户界面(User Interface) － 包括地址栏、后退/前进按钮、书签目录等，也就是你所看到的除了用来显示你所请求页面的主窗口之外的其他部分

- 浏览器引擎(Browser Engine) － 用来查询及操作渲染引擎的接口

- 渲染引擎(Rendering Engine) － 用来显示请求的内容，例如，如果请求内容为html，它负责解析html及css，并将解析后的结果显示出来

- 网络(Networking) － 用来完成网络调用，例如http请求，它具有平台无关的接口，可以在不同平台上工作

- JS解释器(JS Interpreter － 用来解释执行JS代码

- UI后端(UI Backend) － 用来绘制类似组合选择框及对话框等基本组件，具有不特定于某个平台的通用接口，底层使用操作系统的用户接口

- 数据存储(DB Persistence) － 属于持久层，浏览器需要在硬盘中保存类似cookie的各种数据，HTML5定义了web database技术，这是一种轻量级完整的客户端存储技术

![noderun](~@images/exam/browser.png)

1. 浏览器是多进程的

浏览器是多进程的，有一个主控进程，以及每一个tab页面都会新开一个进程（某些情况下多个tab会合并进程）
进程可能包括主控进程，插件进程，GPU，tab页（浏览器内核）等等

- Browser进程：浏览器的主进程（负责协调、主控），只有一个
- 第三方插件进程：每种类型的插件对应一个进程，仅当使用该插件时才创建
- GPU进程：最多一个，用于3D绘制
- 浏览器渲染进程（内核）：默认每个Tab页面一个进程，互不影响，控制页面渲染，脚本执行，事件处理等（有时候会优化，如多个空白tab会合并成一个进程）

2. 浏览器内核是多线程的

我们可以将每一tab页面看成是一个新的浏览器内核进程，每一个进程都由多个线程组成，线程可以分为5大类：

- GUI线程
- JS引擎线程
- 事件触发线程
- 定时器线程
- 网络请求线程

浏览器内核渲染流程：

- 解析HTML，构建DOM树
- 解析CSS，构建样式（css）规则树
- 合并（attachment）DOM树和样式规则书，生成render树
- 布局render树，主要计算元素的位置、尺寸大小，这一过程也称为Layout/reflow（回流）
- 绘制render树，绘制页面像素信息，这一过程称为painting。

![noderun](~@images/exam/webkit-render.png)


各步骤原理：

1. HTML解析，构建DOM

Bytes → characters → tokens → nodes → DOM


![noderun](~@images/exam/html-parser.png)

- Conversion转换：浏览器将获得的HTML内容（Bytes）基于他的编码转换为单个字符

- Tokenizing分词：浏览器按照HTML规范标准将这些字符转换为不同的标记token。每个token都有自己独特的含义以及规则集

- Lexing词法分析：分词的结果是得到一堆的token，此时把他们转换为对象，这些对象分别定义他们的属性和规则

- DOM构建：因为HTML标记定义的就是不同标签之间的关系，这个关系就像是一个树形结构一样
例如：body对象的父节点就是HTML对象，然后段略p对象的父节点就是body对象

2. 解析CSS，生成CSS规则树

Bytes → characters → tokens → nodes → CSSOM

![noderun](~@images/exam/css-parser.png)

3. 合并dom树和css规则树，生成render树

![noderun](~@images/exam/render-parser.png)

4. 布局render树（Layout/Reflow）和绘制render树（Paint）

![noderun](~@images/exam/to-view.png)


布局：通过渲染树中渲染对象的信息，计算出每一个渲染对象的位置和尺寸。

绘制：系统会遍历呈现树，并调用呈现器的“paint”方法，将呈现器的内容显示在屏幕上。


### 断开连接

- TCP四次挥手

[TCP和UDP](/notes/2020-01-30-TCP-and-UDP)

### 回流（reflow）和重绘（repaint）

- 回流：

指元素的内容、结构、位置、大小发生变化，浏览器需要重新计算。

回流包括：

1. 添加、删除元素
2. 更改元素的display:none或显示引起reflow
3. 增加或删除元素style规则，不同规则影响不同，如修改width会引起reflow
4. 移动元素位置
5. CSS3动画，每一帧都会引起reflow(可能有硬件加速)
6. 用户行为如改变浏览器字体大小、改变窗口大小、在输入框输入文字、触发:hover等等

- 重绘：

指元素的一些外观发生了改变，例如背景、边框、文字颜色，只需要重新绘制这个元素就可以了。

- 回流和重绘的影响：

reflow比repaint开销更大，修改一个元素的大小或位置会影响它的子节点，父节点，兄弟节点甚至是整个文档。例如修改页面字体大小，将会导致整个文档reflow。

例如添加一个元素，会导致该元素后面的所有元素位置发生改变。

参考链接：

[从URL输入到页面展现到底发生什么？](https://juejin.cn/post/6844903784229896199)



