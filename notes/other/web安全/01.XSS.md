---
title: "XSS"
date: "2020-01-29"
permalink: "notes/2020-01-30-XSS"
---

⚡<strong>「内容速览」</strong>⚡

- 什么是 XSS
- XSS 分类
- XSS 攻击的预防

### 什么是 XSS
XSS全称Cross-Site Scripting（跨站脚本攻击），是一种代码注入攻击。攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。当其它用户浏览目标网站时，恶意脚本执行，从而控制用户浏览器行为。

常见的xss危害包括：
- 获取用户的敏感信息如 Cookie、SessionID
- 劫持用户（浏览器）会话，从而执行任意操作，例如进行非法转账、强制发表日志、发送电子邮件等
- 强制弹出广告页面，刷流量等
- 传播跨站脚本蠕虫，网页挂马等
- 结合其他漏洞，如 CSRF 漏洞，实施进一步的攻击

**XSS 的本质是：恶意代码未经过滤，与网站正常的代码混在一起；浏览器是无法分辨哪些脚本是可信的哪些是不可信的，从而导致恶意脚本被执行。**

XSS的注入方式：用户的 UGC 内容，URL 上的参数。

### XSS 分类
XSS 攻击按是否把攻击数据存进服务器端，可分为非持久型 XSS 攻击和持久型 XSS 攻击。

XSS 攻击按攻击方式又可分为 反射型 XSS、存储型 XSS、DOM 型 XSS。

- 反射型XSS：
反射型XSS指攻击者构造一个带有恶意代码的 URL 并诱导用户访问。

**由于需要用户主动打开恶意的 URL 才能生效，攻击者往往会结合多种手段诱导用户点击，这种漏洞常见于通过 URL 传递参数的功能，如网站搜索、跳转等。**

步骤如下：
1. 攻击者构造出特殊的 URL，其中包含恶意代码。
2. 用户打开带有恶意代码的 URL 时，网站服务端将恶意代码从 URL 中取出，拼接在 HTML 中返回给浏览器。
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

- 存储型 XSS

存储型 XSS指攻击者将恶意代码提交到目标网站服务器的数据库中。

存储型 XSS 跟 反射型 XSS 的区别是：存储型 XSS 的恶意代码存在服务器上，反射型 XSS 的恶意代码存在 URL 里。它是最危险的一种跨站脚本，比反射性 XSS 和 DOM 型 XSS 都更有隐蔽性，因为它不需要用户手动触发。

**这种攻击常见于带有用户保存数据的网站功能，如论坛发帖、商品评论、用户私信等。**

步骤如下：
1. 攻击者将恶意代码提交到目标网站的数据库中。
2. 用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在 HTML 中返回给浏览器。
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

- DOM 型 XSS
DOM 型 XSS 形成原因是通过修改页面的 DOM 节点形成的 XSS。实际上就是网站前端 JavaScript 代码本身不够严谨，把不可信的数据当作代码执行了。

DOM 型 XSS 跟前两种 XSS 的区别：DOM 型 XSS 攻击中，取出和执行恶意代码由浏览器端完成，属于前端 JavaScript 自身的安全漏洞，而其他两种 XSS 都属于服务端的安全漏洞。

步骤如下：
1. 攻击者构造出特殊的 URL，其中包含恶意代码。
2. 用户打开带有恶意代码的 URL。
3. 用户浏览器接收到响应后解析执行，前端 JavaScript 取出 URL 中的恶意代码并执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

### XSS 攻击的预防

XSS攻击的两大要素：
1. 攻击者提交恶意代码。
2. 浏览器执行恶意代码。

- 浏览器自带防御 （X-XSS-Protection ）
HTTP X-XSS-Protection 响应头是 Internet Explorer，Chrome 和 Safari 的一个功能，当检测到跨站脚本攻击(XSS)时，浏览器将停止加载页面。

这种浏览器自带的防御功能只对反射型 XSS 有一定的防御力，其原理是检查 URL 和 DOM 中元素的相关性，但这并不能完全防止反射型 XSS，而且也并不是所有浏览器都支持 X-XSS-Protection。

```http
X-XSS-Protection: 0     
禁止XSS过滤。     

X-XSS-Protection: 1       
启用XSS过滤（通常浏览器是默认的）。 如果检测到跨站脚本攻击，浏览器将清除页面（删除不安全的部分）。  

X-XSS-Protection: 1; mode=block  
启用XSS过滤。 如果检测到攻击，浏览器将不会清除页面，而是阻止页面加载。  

X-XSS-Protection: 1; report=<reporting-uri>    
启用XSS过滤。 如果检测到跨站脚本攻击，浏览器将清除页面并使用CSP report-uri指令的功能发送违规报告。  
```

- 输入过滤
对于明确的输入类型，例如数字、URL、电话号码、邮件地址等等内容，进行输入过滤。

注：输入侧过滤能够在某些情况下解决特定的 XSS 问题，但会引入很大的不确定性和乱码问题。在防范 XSS 攻击时应避免此类方法。

- 改成纯前端渲染，把代码和数据分隔开

下面要设置的内容是文本（.innerText），还是属性（.setAttribute），还是样式（.style）等等。浏览器不会被轻易的被欺骗，执行预期外的代码了

- 转义HTML

如果拼接 HTML 是必要的，就需要采用合适的转义库，对 HTML 模板各处插入点进行充分的转义。

- 内容安全策略 Content Security Policy
实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行，大大增强了网页的安全性。

严格的 CSP 在 XSS 的防范中可以起到以下的作用：

1. 禁止加载外域代码，防止复杂的攻击逻辑。
2. 禁止外域提交，网站被攻击后，用户的数据不会泄露到外域。
3. 禁止内联脚本执行（规则较严格，目前发现 GitHub 使用）。
4. 禁止未授权的脚本执行（新特性，Google Map 移动版在使用）。
5. 合理使用上报可以及时发现 XSS，利于尽快修复问题。



参考文章：

[前端安全系列（一）：如何防止XSS攻击？](https://tech.meituan.com/2018/09/27/fe-security.html)

[跨站脚本攻击—XSS](https://segmentfault.com/a/1190000020402185)