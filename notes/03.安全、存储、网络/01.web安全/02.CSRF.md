---
title: "CSRF"
date: "2020-01-29"
permalink: "notes/2020-01-30-CSRF"
---

⚡<strong>「内容速览」</strong>⚡

- 什么是 CSRF
- CSRF的类型
- CSRF的特点
- CSRF 攻击的预防

### 什么是 CSRF
CSRF全称Cross-site request forgery（跨站请求伪造），指攻击者诱导受害者进入第三方网站，第三方网站中在受害者不知道的情况下，向被攻击网站发送跨站请求。**利用受害者在被攻击网站已经获取的用户凭证，绕过后台的用户验证，达到冒充用户对被攻击的网站执行某项操作的目的。**


一个典型的CSRF攻击有着如下的流程：

1. 受害者登录a.com，并保留了登录凭证（Cookie）。
2. 攻击者引诱受害者访问了b.com。
3. b.com 向 a.com 发送了一个请求：a.com/act=xx。浏览器会默认携带a.com的Cookie。
4. a.com接收到请求后，对请求进行验证，并确认是受害者的凭证，误以为是受害者自己发送的请求。
5. a.com以受害者的名义执行了act=xx。
6. 攻击完成，攻击者在受害者不知情的情况下，冒充受害者，让a.com执行了自己定义的操作。

### CSRF的类型
- GET类型的CSRF

这种类型的CSRF利用非常简单，只需要一个HTTP请求，例如图片的src。

- POST类型的CSRF

这种类型的CSRF利用起来通常使用的是一个自动提交的表单。

- 链接类型的CSRF

这种类型通常是在论坛中发布的图片中嵌入恶意链接，或者以广告的形式诱导用户中招。


### CSRF的特点

1. 攻击一般发起在第三方网站，而不是被攻击的网站。被攻击的网站无法防止攻击发生。
2. 攻击利用受害者在被攻击网站的登录凭证，冒充受害者提交操作；而不是直接窃取数据。
3. 整个过程攻击者并不能获取到受害者的登录凭证，仅仅是“冒用”。
4. 跨站请求可以用各种方式：图片URL、超链接、CORS、Form提交等等。部分请求方式可以直接嵌入在第三方论坛、文章中，难以进行追踪。


### CSRF 攻击的预防

CSRF攻击的两大要素：
1. CSRF（通常）发生在第三方域名。
2. CSRF攻击者不能获取到Cookie等信息，只是使用。

针对上面的两个要素，我们可以指定对应的防御策略：

1. 阻止不明外域的访问
  - 同源检测
  - Samesite Cookie
2. 提交时要求附加本域才能获取的信息
  - CSRF Token
  - 双重Cookie验证
3. 强制用户进行交互
  - 验证码

- 同源检测

检查跨域请求中的：Origin Header，Referer Header。Origin Header和Referer Header都是请求来源域名。

Origin Header存在于CORS跨域请求中，表示当前请求资源所在页面的协议和域名，不包含路径等信息。

Referer Header存在于所有http请求中，表示HTTP请求的来源地址。

同源验证是一个相对简单的防范方法，能够防范绝大多数的CSRF攻击。但并不能排除本域发起，如果攻击者有权限在本域发布评论权限，那么它可以直接在本域发起攻击。对于安全性要求较高，或者有较多用户输入内容的网站，我们就要对关键的接口做额外的防护措施。

- CSRF Token

而CSRF攻击之所以能够成功，是因为服务器误把攻击者发送的请求当成了用户自己的请求。那么我们在请求中加入攻击者无法获取的信息，这个信息不保存在cookie当中。

例如可以要求所有的用户请求都携带一个CSRF攻击者无法获取到的Token。服务器通过校验请求是否携带正确的Token，来把正常的请求和攻击的请求区分开，也可以防范CSRF的攻击。

CSRF Token的防护策略分为三个步骤：
1. 将CSRF Token输出到页面中
2. 页面提交的请求携带这个Token
3. 服务器验证Token是否正确

一般Token都包括随机字符串和时间戳的组合，并且存在服务器的Session中，但在分布式的服务当中，使用Session存储CSRF Token会带来很大的压力，目前很多网站采用Encrypted Token Pattern方式。

这种方法的Token是一个计算出来的结果，Token的值通常是将UserID、时间戳和随机数通过加密的方法生成。服务器收到token后解密token，访问解析值将UserID与当前登录的UserID进行比较，并将时间戳与当前时间进行比较从而验证有效性。


- 验证码
CSRF往往是在用户不知道的情况下构成网络请求，而验证码就能强制用户与应用进行交互，才能够完成最终操作。

- Samesite Cookie属性
Google起草了一份草案来改进HTTP协议，那就是为Set-Cookie响应头新增Samesite属性，它用来标明这个 Cookie是个“同站 Cookie”，Samesite 有两个属性值，分别是 Strict 和 Lax。

Samesite=Strict
这种称为严格模式，表明这个 Cookie 在任何情况下都不可能作为第三方 Cookie，绝无例外。

Samesite=Lax
这种称为宽松模式，比 Strict 放宽了点限制：假如这个请求是这种请求（改变了当前页面或者打开了新页面）且同时是个GET请求，则这个Cookie可以作为第三方Cookie。